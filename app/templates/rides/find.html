{% extends "base.html" %}
{% block title %}Find a Ride — BroLift{% endblock %}
{% block extra_head %}
<script src="https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&libraries=places&callback=initFindMap" async
    defer></script>
{% endblock %}
{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1>Find a Ride</h1>
        <p>Search for available rides heading to SRM IST from your area</p>
    </div>

    <div class="search-card">
        <form method="POST" class="search-form">
            <div class="search-field">
                <label for="pickup_location">Your Pickup Location (optional)</label>
                <input type="text" id="pickup_location" name="pickup_location"
                    placeholder="Where should they pick you up?" value="{{ search_data.get('pickup_location', '') }}"
                    autocomplete="off">
            </div>
            <div class="search-field">
                <label for="search_date">Date <span style="color:var(--accent-light)">*</span></label>
                <input type="date" id="search_date" name="search_date" value="{{ search_data.get('search_date', '') }}"
                    required>
            </div>
            <div class="search-field">
                <label for="preferred_time">Filter by Time (optional)</label>
                <input type="time" id="preferred_time" name="preferred_time"
                    value="{{ search_data.get('preferred_time', '') }}">
            </div>
            <button type="submit" class="btn-search">Search Rides</button>
        </form>
    </div>

    <div class="find-layout">
        <div class="find-results-col">
            {% if rides %}
            <h3 class="results-count">{{ rides|length }} ride{{ 's' if rides|length != 1 }} found</h3>
            <div class="rides-list">
                {% for ride in rides %}
                <div class="ride-card-full"
                    onclick="selectRide({{ ride.id }}, {{ ride.start_lat or 0 }}, {{ ride.start_lng or 0 }})">
                    <div class="ride-host-info">
                        <div class="host-avatar">{{ ride.host.name[0].upper() }}</div>
                        <div>
                            <div class="host-name">{{ ride.host.name }}</div>
                            <div class="host-car">{{ ride.host.car_model or 'Car' }} — {{ ride.host.car_number or '' }}
                            </div>
                        </div>
                        <span class="ride-badge status-{{ ride.status }}">{{ ride.status }}</span>
                    </div>
                    <div class="ride-route-info">
                        <div class="route-from">From: {{ ride.start_location }}</div>
                        <div class="route-arrow-full">——————</div>
                        <div class="route-to">To: {{ ride.destination }}</div>
                    </div>
                    <div class="ride-details-row">
                        <div class="detail-chip">{{ ride.departure_time.strftime('%d %b, %I:%M %p') }}</div>
                        <div class="detail-chip">{{ ride.seats_available }} seat{{ 's' if ride.seats_available != 1 }}
                            left</div>
                        <div class="detail-chip">Rs.{{ ride.cost_per_person }} / person</div>
                    </div>
                    {% if ride.notes %}
                    <div class="ride-notes">Note: {{ ride.notes }}</div>
                    {% endif %}
                    <a href="{{ url_for('rides.ride_detail', ride_id=ride.id) }}" class="btn-view-ride"
                        onclick="event.stopPropagation()">View and Request</a>
                </div>
                {% endfor %}
            </div>
            {% elif search_data %}
            <div class="no-results">
                <h3>No rides found</h3>
                <p>No rides available on this date. Try a different date or check back later.</p>
            </div>
            {% else %}
            <div class="no-results">
                <h3>Search for rides above</h3>
                <p>Select a date to see all available rides for that day.</p>
            </div>
            {% endif %}
        </div>

        <div class="find-map-col">
            <div class="map-card sticky-map">
                <div class="map-label">Rides Map</div>
                <div id="find-map" class="google-map"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    var map;
    var COLLEGE_LAT = {{ college_lat }};
    var COLLEGE_LNG = {{ college_lng }};

    var rides = [
        {% for ride in rides %}
    {
        id: { { ride.id } }, lat: { { ride.start_lat or 0 } }, lng: { { ride.start_lng or 0 } },
        label: { { ride.host.name | tojson } } + " — " + {{ ride.departure_time.strftime('%I:%M %p') | tojson }
    } },
    {% endfor %}
];

    var darkMapStyle = [
        { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#9ca3af' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d3561' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0f3460' }] },
        { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#162032' }] }
    ];

    function initFindMap() {
        map = new google.maps.Map(document.getElementById('find-map'), {
            center: { lat: COLLEGE_LAT, lng: COLLEGE_LNG },
            zoom: 12,
            styles: darkMapStyle
        });

        new google.maps.Marker({
            position: { lat: COLLEGE_LAT, lng: COLLEGE_LNG },
            map: map,
            title: 'SRM IST Campus',
            icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
        });

        rides.forEach(function (ride) {
            if (ride.lat && ride.lng) {
                var marker = new google.maps.Marker({
                    position: { lat: ride.lat, lng: ride.lng },
                    map: map,
                    title: ride.label,
                    icon: { url: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png' }
                });
                var info = new google.maps.InfoWindow({ content: '<div style="color:#000;font-weight:600">' + ride.label + '</div>' });
                marker.addListener('click', function () { info.open(map, marker); });
            }
        });

        var pickup = document.getElementById('pickup_location');
        if (pickup) {
            new google.maps.places.Autocomplete(pickup, { componentRestrictions: { country: 'in' } });
        }
    }

    function selectRide(rideId, lat, lng) {
        if (lat && lng && map) {
            map.setCenter({ lat: lat, lng: lng });
            map.setZoom(14);
        }
    }
</script>
{% endblock %}