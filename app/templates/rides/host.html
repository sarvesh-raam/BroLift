{% extends "base.html" %}
{% block title %}Host a Ride ‚Äî BroLift{% endblock %}
{% block extra_head %}
<script>
    // Load maps with error handling ‚Äî no dependencies on Places API for the route map
    function loadMapsScript() {
        var s = document.createElement('script');
        s.src = 'https://maps.googleapis.com/maps/api/js?key={{ maps_key }}&libraries=places&callback=initHostMap';
        s.async = true; s.defer = true;
        s.onerror = function () { document.getElementById('map-error').style.display = 'block'; };
        document.head.appendChild(s);
    }
    window.gm_authFailure = function () { document.getElementById('map-error').style.display = 'block'; };
    window.addEventListener('load', loadMapsScript);
</script>
{% endblock %}
{% block content %}
<div class="app-page">
    <div class="app-header">
        <a href="{{ url_for('dashboard.index') }}" class="app-back">‚Üê</a>
        <h1 class="app-title">Host a Ride</h1>
    </div>

    <div class="host-layout">
        <div class="host-form-col">
            {% if errors %}
            <div class="error-list">
                {% for e in errors %}<div class="error-item">{{ e }}</div>{% endfor %}
            </div>
            {% endif %}

            <form method="POST" id="host-form" class="app-form">

                <!-- Route Section -->
                <div class="form-section-label">Route</div>
                <div class="route-input-card">
                    <div class="route-input-row">
                        <span class="route-dot green-dot-sm"></span>
                        <input type="text" id="start_location" name="start_location" placeholder="Start location..."
                            value="{{ form_data.get('start_location', '') }}" required autocomplete="off"
                            class="route-input">
                        <input type="hidden" id="start_lat" name="start_lat">
                        <input type="hidden" id="start_lng" name="start_lng">
                        <input type="hidden" id="distance_km" name="distance_km" value="0">
                    </div>
                    <div class="route-divider-line"></div>
                    <div class="route-input-row">
                        <span class="route-dot blue-dot-sm"></span>
                        <input type="text" value="{{ college_name }}" readonly class="route-input" style="opacity:0.6">
                        <input type="hidden" name="destination" value="{{ college_name }}">
                        <input type="hidden" id="dest_lat" name="dest_lat" value="{{ college_lat }}">
                        <input type="hidden" id="dest_lng" name="dest_lng" value="{{ college_lng }}">
                    </div>
                </div>
                <div id="dist-badge" class="dist-badge" style="display:none">
                    <span id="dist-text"></span>
                </div>

                <!-- Time & Seats -->
                <div class="form-section-label">Trip Details</div>
                <div class="app-form-row">
                    <div class="app-form-group">
                        <label>Departure Time</label>
                        <input type="datetime-local" id="departure_time" name="departure_time"
                            value="{{ form_data.get('departure_time', '') }}" required>
                    </div>
                    <div class="app-form-group">
                        <label>Seats to Offer</label>
                        <select id="available_seats" name="available_seats" required>
                            {% set vtype = current_user.vehicle_type or 'car' %}
                            {% set vcap = current_user.vehicle_capacity or 5 %}
                            {% if vtype == 'bike' %}
                            <option value="1">1 (Pillion)</option>
                            {% else %}
                            {% for i in range(1, vcap) %}
                            <option value="{{ i }}" {% if form_data.get('available_seats')==i|string %}selected{% endif
                                %}>
                                {{ i }} seat{{ 's' if i > 1 }}
                            </option>
                            {% endfor %}
                            {% endif %}
                        </select>
                        <span class="form-hint">
                            {% if vtype == 'bike' %}Bike ‚Äî 1 seat{% else %}{{ vcap }}-seater{% endif %}
                        </span>
                    </div>
                </div>

                <!-- Fuel Section -->
                <div class="form-section-label">Fuel Cost</div>
                <div class="fuel-type-card">
                    <div class="fuel-type-grid">
                        {% for ft, label, icon in
                        [('petrol','Petrol','‚õΩ'),('diesel','Diesel','üõ¢'),('cng','CNG','üí®'),('electric','Electric','‚ö°')]
                        %}
                        <label class="fuel-chip {% if (current_user.fuel_type or 'petrol') == ft %}active{% endif %}">
                            <input type="radio" name="fuel_type" value="{{ ft }}" {% if (current_user.fuel_type
                                or 'petrol' )==ft %}checked{% endif %} onchange="onFuelTypeChange()">
                            <span class="fuel-icon">{{ icon }}</span>
                            <span class="fuel-label">{{ label }}</span>
                            <span class="fuel-price" id="price-{{ ft }}"></span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <div class="app-form-row">
                    <div class="app-form-group">
                        <label>Your Mileage</label>
                        <div class="mileage-value-box">{{ current_user.vehicle_mileage or 15 }} km/L</div>
                        <a href="{{ url_for('auth.profile') }}" class="form-hint-link">Update in profile</a>
                    </div>
                    <div class="app-form-group">
                        <label>Fuel Cost (Rs.)</label>
                        <input type="number" id="fuel_cost" name="fuel_cost" min="0" step="1"
                            placeholder="Auto-calculated" value="{{ form_data.get('fuel_cost', '') }}">
                        <span class="form-hint">Edit if needed</span>
                    </div>
                </div>

                <!-- Cost Summary Card -->
                <div class="cost-card" id="cost-card" style="display:none">
                    <div class="cost-card-row">
                        <span>Distance</span><strong id="cc-dist">‚Äî</strong>
                    </div>
                    <div class="cost-card-row">
                        <span>Total Fuel</span><strong id="cc-fuel">‚Äî</strong>
                    </div>
                    <div class="cost-card-row cost-highlight">
                        <span>Per Person Share</span>
                        <strong id="cc-per-person">‚Äî</strong>
                    </div>
                    <div class="cost-card-note" id="cc-note"></div>
                </div>

                <div class="app-form-group">
                    <label>Notes (Optional)</label>
                    <textarea name="notes" rows="2"
                        placeholder="e.g. Pickup from main road only...">{{ form_data.get('notes', '') }}</textarea>
                </div>

                <button type="submit" class="app-btn-primary">Post Ride ‚Äî Go Live</button>
            </form>
        </div>

        <div class="host-map-col">
            <div class="map-card">
                <div class="map-label">Route Preview</div>
                <div id="map-error" class="map-error-msg" style="display:none">
                    Maps not available. <a href="https://console.cloud.google.com/apis/library" target="_blank">Enable
                        Maps API</a>
                </div>
                <div id="host-map" class="google-map"></div>
                <div class="map-legend">
                    <span class="legend-item"><span class="dot green"></span> Start</span>
                    <span class="legend-item"><span class="dot blue"></span> SRM IST</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
    var map, directionsService, directionsRenderer;
    var COLLEGE_LAT = {{ college_lat }};
    var COLLEGE_LNG = {{ college_lng }};
    var MILEAGE = {{ current_user.vehicle_mileage or 15 }};

    // Fuel prices (Chennai, Feb 2026)
    var FUEL_DATA = {
        petrol: { price: 102.63, unit: '/L', label: '‚Çπ102.63/L' },
        diesel: { price: 88.74, unit: '/L', label: '‚Çπ88.74/L' },
        cng: { price: 72.00, unit: '/kg', label: '‚Çπ72/kg' },
        electric: { price: 0, unit: '', label: '‚Çπ1.5/km' }
    };

    // Show current prices on load
    Object.keys(FUEL_DATA).forEach(function (ft) {
        var el = document.getElementById('price-' + ft);
        if (el) el.textContent = FUEL_DATA[ft].label;
    });

    var darkMapStyle = [
        { elementType: 'geometry', stylers: [{ color: '#1a1a2e' }] },
        { elementType: 'labels.text.stroke', stylers: [{ color: '#1a1a2e' }] },
        { elementType: 'labels.text.fill', stylers: [{ color: '#9ca3af' }] },
        { featureType: 'road', elementType: 'geometry', stylers: [{ color: '#2d3561' }] },
        { featureType: 'water', elementType: 'geometry', stylers: [{ color: '#0f3460' }] },
        { featureType: 'poi', elementType: 'geometry', stylers: [{ color: '#162032' }] }
    ];

    function initHostMap() {
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer();
        map = new google.maps.Map(document.getElementById('host-map'), {
            center: { lat: COLLEGE_LAT, lng: COLLEGE_LNG },
            zoom: 12, styles: darkMapStyle
        });
        directionsRenderer.setMap(map);
        new google.maps.Marker({
            position: { lat: COLLEGE_LAT, lng: COLLEGE_LNG },
            map: map, title: 'SRM IST Campus',
            icon: { url: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png' }
        });
        var ac = new google.maps.places.Autocomplete(
            document.getElementById('start_location'),
            { componentRestrictions: { country: 'in' } }
        );
        ac.addListener('place_changed', function () {
            var place = ac.getPlace();
            if (place.geometry) {
                document.getElementById('start_lat').value = place.geometry.location.lat();
                document.getElementById('start_lng').value = place.geometry.location.lng();
                drawRoute(place.geometry.location);
            }
        });
    }

    function drawRoute(origin) {
        directionsService.route({
            origin: origin,
            destination: { lat: COLLEGE_LAT, lng: COLLEGE_LNG },
            travelMode: google.maps.TravelMode.DRIVING
        }, function (result, status) {
            if (status === 'OK') {
                directionsRenderer.setDirections(result);
                var distKm = parseFloat((result.routes[0].legs[0].distance.value / 1000).toFixed(1));
                document.getElementById('distance_km').value = distKm;
                document.getElementById('dist-badge').style.display = 'flex';
                document.getElementById('dist-text').textContent = distKm + ' km to SRM IST';
                calcFuelCost(distKm);
            }
        });
    }

    function getFuelType() {
        var r = document.querySelector('input[name="fuel_type"]:checked');
        return r ? r.value : 'petrol';
    }

    function calcFuelCost(distKm) {
        var ft = getFuelType();
        var cost = 0;
        if (ft === 'electric') {
            cost = Math.ceil(distKm * 1.5);   // Rs.1.5/km
        } else {
            var pricePerUnit = FUEL_DATA[ft].price;
            cost = Math.ceil((distKm / MILEAGE) * pricePerUnit);
        }
        document.getElementById('fuel_cost').value = cost;
        updateCostCard(distKm, cost);
    }

    function updateCostCard(distKm, fuelCost) {
        var seats = parseInt(document.getElementById('available_seats').value) || 1;
        fuelCost = parseFloat(fuelCost) || 0;
        if (!fuelCost) { document.getElementById('cost-card').style.display = 'none'; return; }
        var perPerson = (fuelCost / (seats + 1)).toFixed(0);
        document.getElementById('cc-dist').textContent = (distKm || '‚Äî') + (distKm ? ' km' : '');
        document.getElementById('cc-fuel').textContent = 'Rs.' + fuelCost;
        document.getElementById('cc-per-person').textContent = 'Rs.' + perPerson;
        document.getElementById('cc-note').textContent = 'Split between you + ' + seats + ' passenger' + (seats > 1 ? 's' : '');
        document.getElementById('cost-card').style.display = 'block';
    }

    function onFuelTypeChange() {
        var dist = parseFloat(document.getElementById('distance_km').value);
        if (dist) calcFuelCost(dist);
        // Update fuel chip UI
        document.querySelectorAll('.fuel-chip').forEach(function (chip) {
            chip.classList.remove('active');
        });
        var selected = document.querySelector('input[name="fuel_type"]:checked');
        if (selected) selected.closest('.fuel-chip').classList.add('active');
    }

    document.getElementById('available_seats').addEventListener('change', function () {
        var dist = parseFloat(document.getElementById('distance_km').value);
        var cost = parseFloat(document.getElementById('fuel_cost').value);
        if (cost) updateCostCard(dist, cost);
    });
    document.getElementById('fuel_cost').addEventListener('input', function () {
        var dist = parseFloat(document.getElementById('distance_km').value);
        updateCostCard(dist, this.value);
    });
</script>
{% endblock %}